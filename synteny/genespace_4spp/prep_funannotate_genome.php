<?php
$sRunDir = "rundir";
/*
$sScfPrefix = "bahahascf_"; //to be removed from scaffold names, leaving only numbers
$sSp = "Bahaha_taipingensis";
$sVersion = "1.0";
$sLongestIsoformProt = "/data/projects/rcui/bahaha_assembly/release1.0/annotations/btp.longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Collichthys_lucidus";
$sVersion = "collichthys_lucidus";
$sLongestIsoformProt = "/data/projects/rcui/bahaha_assembly/annotations/protein_refs/collichthys_lucidus/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Nibea_albiflora";
$sVersion = "nibea_albiflora";
$sLongestIsoformProt = "/data/projects/rcui/bahaha_assembly/annotations/protein_refs/nibea_albiflora/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Larimichthys_crocea";
$sVersion = "JimeiU";
$sLongestIsoformProt = "/data/projects/rcui/bahaha_assembly/annotations/protein_refs/larimichthys_crocea_jimeiU/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Cheilinus_undulatus";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/rcui/bahaha_assembly/annotations/other_refs/Cheilinus_undulatus/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Datnioides_undecimradiatus";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/rcui/bahaha_assembly/annotations/other_refs/Datnioides_undecimradiatus/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Gasterosteus_aculeatus";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/rcui/bahaha_assembly/annotations/other_refs/Gasterosteus_aculeatus/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Lutjanus_erythropterus";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/rcui/bahaha_assembly/annotations/other_refs/Lutjanus_erythropterus/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Micropterus_salmoides";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/rcui/bahaha_assembly/annotations/other_refs/Micropterus_salmoides/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Sander_lucioperca";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/rcui/bahaha_assembly/annotations/other_refs/Sander_lucioperca/longest_isoform.prot.fa";
*/
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Anabas_testudineus";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/zwang/ncbi/Anabas_testudineus/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Betta_splendens";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/zwang/ncbi/Betta_splendens/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Channa_argus";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/zwang/ncbi/Channa_argus/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Danio_rerio";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/zwang/ncbi/Danio_rerio/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Gadus_morhua";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/zwang/ncbi/Gadus_morhua/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Monopterus_albus";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/zwang/ncbi/Monopterus_albus/longest_isoform.prot.fa";
*/
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Oryzias_latipes";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/zwang/ncbi/Oryzias_latipes/longest_isoform.prot.fa";
*/
/*
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Takifugu_rubripes";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/zwang/ncbi/Takifugu_rubripes/longest_isoform.prot.fa";
 */
/*
$sScfPrefix = "mhkscf_"; //to be removed from scaffold names, leaving only numbers
$sSp = "Macropodus_hongkongensis";
$sVersion = "1.0";
$sLongestIsoformProt = "/data/projects/rcui/macropodus_compare/improve_genemodels_UPhO/mhk/longest.addedUPhO.genesymbol.spgeneid.prot.fa";
 */
/*
$sScfPrefix = "mopscf_"; //to be removed from scaffold names, leaving only numbers
$sSp = "Macropodus_opercularis";
$sVersion = "1.0";
$sLongestIsoformProt = "/data/projects/rcui/macropodus_compare/improve_genemodels_UPhO/mop/longest.addedUPhO.genesymbol.spgeneid.prot.fa";
 */
$sScfPrefix = ""; //to be removed from scaffold names, leaving only numbers
$sSp = "Homo_sapiens";
$sVersion = "1";
$sLongestIsoformProt = "/data/projects/zwang/ncbi/Homo_sapiens/longest_isoform.prot.fa";

$sWD = "$sRunDir/rawGenomes/$sSp/$sVersion/annotation";
exec("mkdir -p $sWD");

$hGFF = false;
if ($sScfPrefix !='') {
	$hGFF = popen("sort -k1,1n -k4,4n | gzip -c > $sWD/$sSp.gene.gff.gz", 'w');
} else {
	$hGFF = popen("sort -k1,1 -k4,4n | gzip -c > $sWD/$sSp.gene.gff.gz", 'w');
}

$hFas = popen("gzip -c > $sWD/$sSp.pep.fa.gz", 'w');

$hIn = popen("zcat -f $sLongestIsoformProt", 'r');

while(false!== ($sLn = fgets($hIn) )) {
	$sLn = trim($sLn);
	if ($sLn == '') {
		continue;
	}

	if ($sLn[0] == '>') {
		$arrF = explode(' ', substr($sLn, 1));
		$sSeqName = $arrF[0];
		$sSeqName = preg_replace('/[:|]/', '_', $sSeqName);
		$sPos = $arrF[count($arrF)-1];
		preg_match('/([^:]+):([^-]+)-([^(]+)\\((\\S)\\)/', $sPos, $arrM);
		if (count($arrM) != 5) {
			die("Failed to parse header: $sLn\n");
		}

		list($sChr, $nStart, $nEnd, $sOrient) = array_slice($arrM, 1);
		$sChr = str_replace($sScfPrefix, '', $sChr);
		fwrite($hGFF, "$sChr\tfunannotate\tgene\t$nStart\t$nEnd\t\t$sOrient\t\tlocus=$sSeqName\n");
		fwrite($hFas, ">$sSeqName\n");
	} else {
		$sLn = str_replace('*', '', $sLn);
		fwrite($hFas, $sLn."\n");
	}

	
}

?>
